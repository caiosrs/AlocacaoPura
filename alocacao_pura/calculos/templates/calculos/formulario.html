<!-- templates/calculos/formulario.html -->
{% extends "calculos/base.html" %}
{% load static %}

{% block title %}Cálculo de valor Alocação Pura{% endblock %}

{% block content %}
    <h1 class="mt-5">Cálculo de Alocação Pura</h1>
    <form method="post" style="padding: 20px;">
        {% csrf_token %}
        <div class="form-group">
            <label for="id_cargo">Cargo</label>
            {{ form.cargo }}
            <div id="autocomplete-suggestions" class="autocomplete-suggestions"></div>
        </div>
        <div class="form-row">
            <div class="form-group col-md-6">
                <label for="id_salario">Salário</label>
                {{ form.salario }}
            </div>
            <div class="form-group col-md-6">
                <label for="id_assistencia_medica">Assistência Médica</label>
                {{ form.assistencia_medica }}
            </div>
        </div>
        <div class="form-row">
            <div class="form-group col-md-6">
                <label>Assistência Odontológica</label>
                {{ form.assistencia_odonto }}
            </div>
            <div class="form-group col-md-6">
                <label>Seguro</label>
                {{ form.seguro }}
            </div>
        </div>
        <div class="form-row">
            <div class="form-group col-md-6">
                <label>Vale Refeição</label>
                {{ form.vr }}
            </div>
            <div class="form-group col-md-6">
                <label>Vale Alimentação</label>
                {{ form.va }}
            </div>
        </div>
        <div class="form-row">
            <div class="form-group col-md-6">
                <label>Vale Transporte</label>
                {{ form.vt }}
            </div>
            <div class="form-group col-md-6">
                <label>Gym Pass</label>
                {{ form.gympass }}
            </div>
        </div>
        <button type="button" class="btn btn-secondary" id="calcular-btn" data-toggle="modal" data-target="#calcularModal">Calcular</button>
        <button type="button" class="btn btn-danger" id="limpar-btn">Limpar</button>
    </form>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const input = document.getElementById('id_cargo');
            const suggestionsContainer = document.getElementById('autocomplete-suggestions');
            const salarioInput = document.getElementById('id_salario');
            let currentFocus = -1;

            function getSuggestions(query) {
                return fetch(`/alocacao-pura/autocomplete_funcionarios/?term=${query}`)
                    .then(response => response.json())
                    .then(data => data);
            }

            function getSalario(cargo) {
                return fetch(`/alocacao-pura/obter_salario/?cargo=${cargo}`)
                    .then(response => response.json())
                    .then(data => data.salario);
            }

            function renderSuggestions(suggestions) {
                suggestionsContainer.innerHTML = '';
                currentFocus = -1;
                suggestions.forEach((suggestion, index) => {
                    const div = document.createElement('div');
                    div.textContent = suggestion;
                    div.classList.add('autocomplete-suggestion');
                    div.addEventListener('click', () => {
                        input.value = suggestion;
                        suggestionsContainer.innerHTML = '';
                        getSalario(suggestion).then(salario => {
                            salarioInput.value = salario ? salario.toFixed(2) : '';
                        });
                    });
                    div.addEventListener('mouseover', () => {
                        currentFocus = index;
                        updateSuggestionHighlight();
                    });
                    suggestionsContainer.appendChild(div);
                });
            }

            function updateSuggestionHighlight() {
                const items = suggestionsContainer.querySelectorAll('.autocomplete-suggestion');
                items.forEach((item, index) => {
                    item.classList.toggle('highlight', index === currentFocus);
                });
            }

            input.addEventListener('input', () => {
                const query = input.value;
                if (query.length >= 3) {
                    getSuggestions(query).then(suggestions => {
                        renderSuggestions(suggestions);
                    });
                } else {
                    suggestionsContainer.innerHTML = '';
                }
            });

            input.addEventListener('keydown', (e) => {
                const items = suggestionsContainer.querySelectorAll('.autocomplete-suggestion');
                if (e.key === 'ArrowDown') {
                    currentFocus++;
                    if (currentFocus >= items.length) currentFocus = 0;
                    updateSuggestionHighlight();
                    input.value = items[currentFocus] ? items[currentFocus].textContent : '';
                } else if (e.key === 'ArrowUp') {
                    currentFocus--;
                    if (currentFocus < 0) currentFocus = items.length - 1;
                    updateSuggestionHighlight();
                    input.value = items[currentFocus] ? items[currentFocus].textContent : '';
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (currentFocus > -1 && items[currentFocus]) {
                        items[currentFocus].click();
                    }
                }
            });

            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !suggestionsContainer.contains(e.target)) {
                    suggestionsContainer.innerHTML = '';
                }
            });
        });
    </script>
{% endblock %}
